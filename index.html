<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Table Tennis Tournament</title>
<style>
  body{
     font-family:monospace;
     background:none;padding:20px;
     transition:background 0s .2s,opacity .4s
    }
  button{
    margin:4px;
    padding:6px 12px;
    font-size:16px;
    transition:color .4s
}
  input{
    padding:4px;
    font-size:16px;
    width:60px;
    margin-top:8px;
    transition:background .4s,color .4s
}
  .scoreboard{margin-top:20px;
    font-size:24px;
    font-weight:bold;
    display:flex;
    flex-direction:column;gap:1em
}
  .scoreboard p{
    font-variant-numeric:tabular-nums
}
  .scoreboard p .colon{position:relative;
    top:-.05em;
    font-size:1.2em
}
  .deuce{
    color:red;
    font-weight:bold
}
  .container{
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center
}
  .scroll-container{
    position:relative;
    display:inline-block;
    width:90px;
    height:70px;
    overflow:hidden;
    vertical-align:bottom
}
  .scrolling-number{
    position:absolute;
    left:0;width:100%;
    font-weight:bold;
    font-size:60px;
    line-height:70px;
    user-select:none;
    top:0
}
  .controls{opacity:0;
    transform:scaleY(0);
    transform-origin:top;
    transition:opacity .4s,transform .4s;
    overflow:hidden
}
  .show-controls .controls{
    opacity:1;
    transform:scaleY(1)
}
  @media(min-width:769px){
    .scroll-container{
        width:3.5em;
        height:2em
    }
    .scrolling-number{
        font-size:2rem;
        line-height:2em
    }
}
  body.dark{
    background:none;
    color:#eee
}
  body.dark button{
    background:#333;
    color:#eee;
    border-color:#888
}
  body.dark input{
    background:#333;
    color:#eee;
    border:1px solid #888
}
  body.dark .scrolling-number{
    color:#fffd
}
  body::before,body::after{content:"";
  position:fixed;
  inset:0;
  z-index:-1;
  transition:opacity .4s;
  pointer-events:none
}
  body::before{
    background:linear-gradient(to right,#80bfe1 50%,#e1726a 50%);
    opacity:1
}
  body::after{
    background:linear-gradient(to right,#042838 50%,#380404 50%);
    opacity:0
}
  body.dark::before{
    opacity:0
}
  body.dark::after{
    opacity:1
}
</style>
</head>
<body>
<div class="container">
  <div style="position:absolute;top:10px;right:10px">
    <button id="muteBtn">üì¢</button>
    <button id="darkModeBtn">üåô</button>
  </div>
  <h2>Table Tennis Scoreboard</h2>
  <label>How many matches? (odd): </label>
  <input id="matchCountInput" type="number" min="1" step="2"/>
  <p id="errorMsg" style="color:red;font-weight:bold;margin:4px"></p>
  <button id="startButton" onclick="startTournament()">Start</button>

  <div id="controls" class="controls">
    <div class="scoreboard">
      <p><span>Whole tournament:</span><br>
        <span class="scroll-container" id="tourn-left"><span class="scrolling-number old">0</span><span class="scrolling-number new"></span></span>
        <span class="colon">:</span>
        <span class="scroll-container" id="tourn-right"><span class="scrolling-number old">0</span><span class="scrolling-number new"></span></span>
      </p>
      <p><span>This Match:</span><br>
        <span class="scroll-container" id="match-left"><span class="scrolling-number old">0</span><span class="scrolling-number new"></span></span>
        <span class="colon">:</span>
        <span class="scroll-container" id="match-right"><span class="scrolling-number old">0</span><span class="scrolling-number new"></span></span>
      </p>
    </div>

    <p><strong>Controls (Left to Right):</strong><br>
      a = Left +1‚ÄÉs = Right +1<br>z = Left ‚àí1‚ÄÉx = Right ‚àí1<br>
      r = restart<br><em>Players swap sides after every match!</em>
    </p>
    <button onclick="updateScore('a')">a (Left +1)</button>
    <button onclick="updateScore('s')">s (Right +1)</button>
    <button onclick="updateScore('z')">z (Left ‚àí1)</button>
    <button onclick="updateScore('x')">x (Right ‚àí1)</button>
    <div id="endPrompt" style="margin-top:10px"></div>
  </div>
  <p id="deuce" class="deuce"></p>
</div>

<script>
let bigLeft=0, bigRight=0, smallLeft=0, smallRight=0;
let totalMatches=0, toWin=0, active=false;
const transitionSound = new Audio("transition.mp3");
transitionSound.volume = 0.8;

const scoreAnimQueues = new Map();
const scoreAnimRunning = new Map();

function enqueueScoreAnimation(container, newValue) {
  if (!scoreAnimQueues.has(container)) {
    scoreAnimQueues.set(container, []);
    scoreAnimRunning.set(container, false);
  }

  const queue = scoreAnimQueues.get(container);
  newValue = newValue.toString();

  const current = container.querySelector('.old').textContent;
  if (current === newValue) return; 
  
  queue.push(newValue);

  if (!scoreAnimRunning.get(container)) {
    scoreAnimRunning.set(container, true);
    processScoreQueue(container);
  }
}

function processScoreQueue(container) {
  const queue = scoreAnimQueues.get(container);
  if (!queue || queue.length === 0) {
    scoreAnimRunning.set(container, false);
    return;
  }

  const newValue = queue[0]; 
  const oldElem = container.querySelector('.old');
  const newElem = container.querySelector('.new');
  const oldValue = parseInt(oldElem.textContent || '0', 10);
  const newNum = parseInt(newValue, 10);

  if (oldValue === newNum) {
    queue.shift(); 
    processScoreQueue(container);
    return;
  }

  transitionSound.currentTime = 0;
  transitionSound.play();

  const goingUp = newNum > oldValue;

  newElem.textContent = newValue;
  newElem.style.transition = 'none';
  newElem.style.opacity = '1';

  if (goingUp) {
    newElem.style.transform = 'translateY(1.4em)'; 
    oldElem.style.transform = 'translateY(0)';
  } else {
    newElem.style.transform = 'translateY(-1.4em)';   
    oldElem.style.transform = 'translateY(0)';
  }
  
  void newElem.offsetWidth; 

  newElem.style.transition = 'transform 0.44s cubic-bezier(0.25,0.8,0.25,1)';
  oldElem.style.transition = 'transform 0.44s cubic-bezier(0.25,0.8,0.25,1)';
  
  if (goingUp) {
    newElem.style.transform = 'translateY(0)';
    oldElem.style.transform = 'translateY(-1.4em)'; 
  } else {
    newElem.style.transform = 'translateY(0)';
    oldElem.style.transform = 'translateY(1.4em)'; 
  }

  setTimeout(() => {
    oldElem.textContent = newValue;
    oldElem.style.transition = 'none';
    oldElem.style.transform = 'translateY(0)';
    
    newElem.style.transition = 'none';
    newElem.style.opacity = '0';
    newElem.style.transform = 'translateY(0)';
    newElem.textContent = '';
    
    queue.shift();
    processScoreQueue(container);
  }, 450);
}

function updateDisplay() {
  enqueueScoreAnimation(document.getElementById('tourn-left'),  bigLeft+'');
  enqueueScoreAnimation(document.getElementById('tourn-right'), bigRight+'');
  enqueueScoreAnimation(document.getElementById('match-left'),  smallLeft+'');
  enqueueScoreAnimation(document.getElementById('match-right'), smallRight+'');

  const deuce = smallLeft>=10 && smallRight>=10 && Math.abs(smallLeft-smallRight)<2;
  document.getElementById('deuce').textContent = deuce ? "Deuce!" : "";
}

function startTournament() {
  const n = parseInt(document.getElementById('matchCountInput').value);
  if (isNaN(n)||n<=0||n%2===0) { alert("Please enter a positive odd number!"); return; }
  totalMatches=n; toWin=Math.floor(n/2)+1;
  bigLeft=bigRight=smallLeft=smallRight=0;
  document.body.classList.add("show-controls");
  document.getElementById('endPrompt').innerHTML='';
  active=true;
  updateDisplay();
}

function updateScore(k) {
  if (!active) return;
  if (k==='a') smallLeft++;
  else if (k==='s') smallRight++;
  else if (k==='z') smallLeft=Math.max(0,smallLeft-1);
  else if (k==='x') smallRight=Math.max(0,smallRight-1);
  checkMatch();
}

function checkMatch() {
  const leftWin  = smallLeft>=11 && smallLeft>=smallRight+2;
  const rightWin = smallRight>=11 && smallRight>=smallLeft+2;
  if (!leftWin && !rightWin) {
    updateDisplay();  
    return;
  }

  if (leftWin) bigLeft++; else bigRight++;

  if (bigLeft >= toWin || bigRight >= toWin) {
    document.getElementById('endPrompt').innerHTML = 
      `<p><b>${bigLeft>=toWin?'Left':'Right'} side wins ${bigLeft}:${bigRight}!</b></p>
       <button onclick="restart()">Play Again</button>`;
    active = false;
  } else {
    alert(`Match won by ${leftWin?'Left':'Right'} side (${smallLeft}-${smallRight})!\nSwapping sides‚Ä¶`);
    [bigLeft, bigRight] = [bigRight, bigLeft];
    smallLeft = smallRight = 0;

    document.body.style.background = "rgba(255,255,100,0.5)";
    setTimeout(()=>document.body.style.background="",400);
  }

  updateDisplay();  
}

function restart() {
  document.body.classList.remove("show-controls");
  document.getElementById('matchCountInput').value='';
  active=false;
}

document.addEventListener("keydown",e=>{
  const k=e.key.toLowerCase();
  if("asxz".includes(k)){e.preventDefault();updateScore(k);}
  if(k==="r") startTournament();
});

let muted=false;
document.getElementById("muteBtn").addEventListener("click",()=>{muted=!muted;transitionSound.muted=muted;document.getElementById("muteBtn").textContent=muted?"üîá":"üì¢";});
window.addEventListener('load',()=>{if(localStorage.getItem("dark")==="true"){document.body.classList.add("dark");document.getElementById("darkModeBtn").textContent="‚òÄÔ∏è";}});
document.getElementById("darkModeBtn").addEventListener("click",()=>{
  document.body.classList.toggle("dark");
  const d=document.body.classList.contains("dark");
  document.getElementById("darkModeBtn").textContent=d?"‚òÄÔ∏è":"üåô";
  localStorage.setItem("dark",d);
});
</script>
</body>
</html>

