<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Table Tennis Tournament</title>
    <style>
      body {
        font-family: monospace;
        background: none;
        padding: 20px;
        transition: background 0s .2s, opacity .4s
      }

      button {
        margin: 2px;
        padding: 6px 12px;
        font-size: 16px;
        transition: color .4s
      }

      input,
      select {
        padding: 4px;
        font-size: 16px;
        margin-top: 4px;
        transition: background .4s, color .4s
      }

      #matchCountInput {
        width: 60px;
      }

      #firstServeSelect {
        width: 120px;
      }

      .scoreboard {
        margin-top: 10px;
        font-size: 24px;
        font-weight: bold;
        display: flex;
        flex-direction: column;
        gap: 0.5em;
      }

      .scoreboard p {
        font-variant-numeric: tabular-nums;
        margin: 5px 0;
      }

      .scoreboard p .colon {
        position: relative;
        top: -.05em;
        font-size: 1.2em
      }

      .deuce {
        color: red;
        font-weight: bold;
        margin: 5px 0;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center
      }

      .score-container {
        position: relative;
        display: inline-block;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .scroll-container {
        position: relative;
        display: inline-block;
        width: 90px;
        height: 70px;
        overflow: hidden;
        vertical-align: middle;
      }

      .scrolling-number {
        position: absolute;
        left: 0;
        width: 100%;
        font-weight: bold;
        font-size: 60px;
        line-height: 70px;
        user-select: none;
        top: 0
      }

      .serve-indicator {
        position: absolute;
        left: 0;
        right: 0;
        height: 70px;
        border: 3px solid transparent;
        border-radius: 8px;
        transition: border-color 0.3s, background-color 0.3s, box-shadow 0.3s;
        pointer-events: none;
      }

      .serving .serve-indicator {
        border-color: #00ff00 !important;
        background-color: rgba(0, 255, 0, 0.1) !important;
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
      }

      .controls {
        opacity: 0;
        transform: scaleY(0);
        transform-origin: top;
        transition: opacity .4s, transform .4s;
        overflow: hidden
      }

      .show-controls .controls {
        opacity: 1;
        transform: scaleY(1)
      }

      @media(min-width:769px) {
        .scroll-container {
          width: 3.5em;
          height: 2em
        }

        .scrolling-number {
          font-size: 2rem;
          line-height: 2em
        }

        .score-container {
          height: 3em;
        }

        .serve-indicator {
          height: 2em;
          top: 0.7em;
        }
      }

      body.dark {
        background: none;
        color: #eee
      }

      body.dark button {
        background: #333;
        color: #eee;
        border-color: #888
      }

      body.dark input,
      body.dark select {
        background: #333;
        color: #eee;
        border: 1px solid #888
      }

      body.dark .scrolling-number {
        color: #fffd
      }

      body::before,
      body::after {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        transition: opacity .4s;
        pointer-events: none
      }

      body::before {
        background: linear-gradient(to right, #80bfe1 50%, #e1726a 50%);
        opacity: 1
      }

      body::after {
        background: linear-gradient(to right, #042838 50%, #380404 50%);
        opacity: 0
      }

      body.dark::before {
        opacity: 0
      }

      body.dark::after {
        opacity: 1
      }

      .score-row {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        margin-bottom: 5px;
      }

      .setup-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        margin-bottom: 10px;
      }

      .setup-controls label {
        margin-bottom: 2px;
      }

      h2 {
        margin: 10px 0;
      }

      #errorMsg {
        margin: 2px 0;
      }

      #startButton {
        margin: 5px 0;
      }

      .score-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 10px 0;
      }

      .player-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .player-label {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .circle-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background: #4CAF50;
        color: white;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
      }

      .circle-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 5px 8px rgba(0, 0, 0, 0.3);
      }

      .circle-btn:active {
        transform: scale(0.95);
      }

      .circle-btn.minus {
        background: #f44336;
      }

      .circle-btn.plus {
        background: #4CAF50;
      }

      .btn-row {
        display: flex;
        gap: 10px;
      }

      body.dark .circle-btn {
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.5);
      }

      body.dark .circle-btn:hover {
        box-shadow: 0 5px 8px rgba(0, 0, 0, 0.7);
      }

      @media (max-width: 768px) {
        .header-controls {
          position: absolute;
          top: 15px;
          right: 15px;
          display: flex;
          gap: 8px;
        }

        h2 {
          margin-top: 60px;
          font-size: 1.5em;
          margin-bottom: 20px;
        }

        .container {
          padding-top: 10px;
        }

        .header-controls button {
          width: 44px;
          height: 44px;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0;
          font-size: 18px;
        }
      }

      @media (min-width: 769px) {
        .header-controls {
          position: absolute;
          top: 10px;
          right: 10px;
          display: flex;
          gap: 5px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header-controls">
      <button id="muteBtn">üì¢</button>
      <button id="darkModeBtn">üåô</button>
    </div>
    <div class="container">
      <h2>Table Tennis Scoreboard</h2>
      <div class="setup-controls">
        <div>
          <label>How many matches? (odd): </label>
          <input id="matchCountInput" type="number" min="1" step="2" />
        </div>
        <div>
          <label>First serve: </label>
          <select id="firstServeSelect">
            <option value="left">Left Player</option>
            <option value="right">Right Player</option>
          </select>
        </div>
      </div>
      <p id="errorMsg" style="color:red;font-weight:bold"></p>
      <button id="startButton" onclick="startTournament()">Start</button>
      <div id="controls" class="controls">
        <div class="scoreboard">
          <p>
            <span>Whole tournament:</span>
            <br>
          <div class="score-row">
            <div class="score-container">
              <span class="scroll-container" id="tourn-left">
                <span class="scrolling-number old">0</span>
                <span class="scrolling-number new"></span>
              </span>
              <div class="serve-indicator"></div>
            </div>
            <span class="colon">:</span>
            <div class="score-container">
              <span class="scroll-container" id="tourn-right">
                <span class="scrolling-number old">0</span>
                <span class="scrolling-number new"></span>
              </span>
              <div class="serve-indicator"></div>
            </div>
          </div>
          </p>
          <p>
            <span>This Match:</span>
            <br>
          <div class="score-row">
            <div class="score-container" id="match-left-container">
              <span class="scroll-container" id="match-left">
                <span class="scrolling-number old">0</span>
                <span class="scrolling-number new"></span>
              </span>
              <div class="serve-indicator"></div>
            </div>
            <span class="colon">:</span>
            <div class="score-container" id="match-right-container">
              <span class="scroll-container" id="match-right">
                <span class="scrolling-number old">0</span>
                <span class="scrolling-number new"></span>
              </span>
              <div class="serve-indicator"></div>
            </div>
          </div>
          </p>
        </div>
        <p>
          <strong>Controls (Left to Right):</strong>
          <br> a = Left +1‚ÄÉs = Right +1 <br>z = Left ‚àí1‚ÄÉx = Right ‚àí1 <br> r = restart <br>
          <em>Players swap sides after every match!</em>
        </p>
        <div class="score-controls">
          <div class="player-controls">
            <div class="player-label">Left Player</div>
            <div class="btn-row">
              <button class="circle-btn plus" onclick="updateScore('a')" title="Left +1">+</button>
              <button class="circle-btn minus" onclick="updateScore('z')" title="Left -1">‚àí</button>
            </div>
          </div>
          <div class="player-controls">
            <div class="player-label">Right Player</div>
            <div class="btn-row">
              <button class="circle-btn plus" onclick="updateScore('s')" title="Right +1">+</button>
              <button class="circle-btn minus" onclick="updateScore('x')" title="Right -1">‚àí</button>
            </div>
          </div>
        </div>
        <div id="endPrompt" style="margin-top:5px"></div>
      </div>
      <p id="deuce" class="deuce"></p>
    </div>
    <script>
      let bigLeft = 0,
        bigRight = 0,
        smallLeft = 0,
        smallRight = 0;
      let totalMatches = 0,
        toWin = 0,
        active = false;
      let currentServer = 'left';
      let firstServer = 'left';
      const transitionSound = new Audio("transition.mp3");
      transitionSound.volume = 0.8;
      let totalPoints = 0;
      const scoreAnimQueues = new Map();
      const scoreAnimRunning = new Map();

      function enqueueScoreAnimation(container, newValue) {
        if (!scoreAnimQueues.has(container)) {
          scoreAnimQueues.set(container, []);
          scoreAnimRunning.set(container, false);
        }
        const queue = scoreAnimQueues.get(container);
        newValue = newValue.toString();
        const current = container.querySelector('.old').textContent;
        if (current === newValue) return;
        queue.push(newValue);
        if (!scoreAnimRunning.get(container)) {
          scoreAnimRunning.set(container, true);
          processScoreQueue(container);
        }
      }

      function processScoreQueue(container) {
        const queue = scoreAnimQueues.get(container);
        if (!queue || queue.length === 0) {
          scoreAnimRunning.set(container, false);
          return;
        }
        const newValue = queue[0];
        const oldElem = container.querySelector('.old');
        const newElem = container.querySelector('.new');
        const oldValue = parseInt(oldElem.textContent || '0', 10);
        const newNum = parseInt(newValue, 10);
        if (oldValue === newNum) {
          queue.shift();
          processScoreQueue(container);
          return;
        }
        transitionSound.currentTime = 0;
        transitionSound.play();
        const goingUp = newNum > oldValue;
        newElem.textContent = newValue;
        newElem.style.transition = 'none';
        newElem.style.opacity = '1';
        if (goingUp) {
          newElem.style.transform = 'translateY(1.4em)';
          oldElem.style.transform = 'translateY(0)';
        } else {
          newElem.style.transform = 'translateY(-1.4em)';
          oldElem.style.transform = 'translateY(0)';
        }
        void newElem.offsetWidth;
        newElem.style.transition = 'transform 0.44s cubic-bezier(0.25,0.8,0.25,1)';
        oldElem.style.transition = 'transform 0.44s cubic-bezier(0.25,0.8,0.25,1)';
        if (goingUp) {
          newElem.style.transform = 'translateY(0)';
          oldElem.style.transform = 'translateY(-1.4em)';
        } else {
          newElem.style.transform = 'translateY(0)';
          oldElem.style.transform = 'translateY(1.4em)';
        }
        setTimeout(() => {
          oldElem.textContent = newValue;
          oldElem.style.transition = 'none';
          oldElem.style.transform = 'translateY(0)';
          newElem.style.transition = 'none';
          newElem.style.opacity = '0';
          newElem.style.transform = 'translateY(0)';
          newElem.textContent = '';
          queue.shift();
          processScoreQueue(container);
        }, 450);
      }

      function updateDisplay() {
        enqueueScoreAnimation(document.getElementById('tourn-left'), bigLeft + '');
        enqueueScoreAnimation(document.getElementById('tourn-right'), bigRight + '');
        enqueueScoreAnimation(document.getElementById('match-left'), smallLeft + '');
        enqueueScoreAnimation(document.getElementById('match-right'), smallRight + '');
        const deuce = smallLeft >= 10 && smallRight >= 10 && Math.abs(smallLeft - smallRight) < 2;
        document.getElementById('deuce').textContent = deuce ? "Deuce!" : "";
        updateServeIndicator();
      }

      function updateServeIndicator() {
        const leftContainer = document.getElementById('match-left-container');
        const rightContainer = document.getElementById('match-right-container');
        leftContainer.classList.remove('serving');
        rightContainer.classList.remove('serving');
        if (currentServer === 'left') {
          leftContainer.classList.add('serving');
        } else {
          rightContainer.classList.add('serving');
        }
      }

      function calculateServeChange(isAdding) {
        const oldTotalPoints = totalPoints;
        totalPoints = smallLeft + smallRight;
        if (smallLeft >= 10 && smallRight >= 10 && Math.abs(smallLeft - smallRight) < 2) {
          if (isAdding) {
            currentServer = currentServer === 'left' ? 'right' : 'left';
          } else {
            currentServer = currentServer === 'left' ? 'right' : 'left';
          }
          return;
        }
        const oldServeGroup = Math.floor(oldTotalPoints / 2);
        const newServeGroup = Math.floor(totalPoints / 2);
        if (isAdding) {
          if (newServeGroup !== oldServeGroup) {
            currentServer = currentServer === 'left' ? 'right' : 'left';
          }
        } else {
          if (newServeGroup !== oldServeGroup) {
            currentServer = currentServer === 'left' ? 'right' : 'left';
          }
        }
      }

      function startTournament() {
        const n = parseInt(document.getElementById('matchCountInput').value);
        if (isNaN(n) || n <= 0 || n % 2 === 0) {
          alert("Please enter a positive odd number!");
          return;
        }
        firstServer = document.getElementById('firstServeSelect').value;
        currentServer = firstServer;
        totalPoints = 0;
        totalMatches = n;
        toWin = Math.floor(n / 2) + 1;
        bigLeft = bigRight = smallLeft = smallRight = 0;
        document.body.classList.add("show-controls");
        document.getElementById('endPrompt').innerHTML = '';
        active = true;
        updateDisplay();
      }

      function updateScore(k) {
        if (!active) return;
        const isAdding = k === 'a' || k === 's';
        const oldSmallLeft = smallLeft;
        const oldSmallRight = smallRight;
        if (k === 'a') smallLeft++;
        else if (k === 's') smallRight++;
        else if (k === 'z') smallLeft = Math.max(0, smallLeft - 1);
        else if (k === 'x') smallRight = Math.max(0, smallRight - 1);
        calculateServeChange(isAdding);
        checkMatch();
      }

      function checkMatch() {
        const leftWin = smallLeft >= 11 && smallLeft >= smallRight + 2;
        const rightWin = smallRight >= 11 && smallRight >= smallLeft + 2;
        if (!leftWin && !rightWin) {
          updateDisplay();
          return;
        }
        if (leftWin) bigLeft++;
        else bigRight++;
        if (bigLeft >= toWin || bigRight >= toWin) {
          document.getElementById('endPrompt').innerHTML = `
												
											<p>
												<b>${bigLeft>=toWin?'Left':'Right'} side wins ${bigLeft}:${bigRight}!</b>
											</p>
											<button onclick="restart()">Play Again</button>`;
          active = false;
        } else {
          alert(`Match won by ${leftWin?'Left':'Right'} side (${smallLeft}-${smallRight})!\nSwapping sides‚Ä¶`);
          [bigLeft, bigRight] = [bigRight, bigLeft];
          smallLeft = smallRight = 0;
          totalPoints = 0;
          currentServer = firstServer;
          document.body.style.background = "rgba(255,255,100,0.5)";
          setTimeout(() => document.body.style.background = "", 400);
        }
        updateDisplay();
      }

      function restart() {
        document.body.classList.remove("show-controls");
        document.getElementById('matchCountInput').value = '';
        active = false;
      }
      document.addEventListener("keydown", e => {
        const k = e.key.toLowerCase();
        if ("asxz".includes(k)) {
          e.preventDefault();
          updateScore(k);
        }
        if (k === "r") startTournament();
      });
      let muted = false;
      document.getElementById("muteBtn").addEventListener("click", () => {
        muted = !muted;
        transitionSound.muted = muted;
        document.getElementById("muteBtn").textContent = muted ? "üîá" : "üì¢";
      });
      window.addEventListener('load', () => {
        if (localStorage.getItem("dark") === "true") {
          document.body.classList.add("dark");
          document.getElementById("darkModeBtn").textContent = "‚òÄÔ∏è";
        }
      });
      document.getElementById("darkModeBtn").addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const d = document.body.classList.contains("dark");
        document.getElementById("darkModeBtn").textContent = d ? "‚òÄÔ∏è" : "üåô";
        localStorage.setItem("dark", d);
      });
    </script>
  </body>
</html>
